{% extends "base.html" %}

{% block title %}경찰 승진 시험 문제은행{% endblock %}

{% block content %}
<div class="container">
    <div class="category-selection">
        <h2>카테고리 선택</h2>
        <div class="categories">
            {% for category in categories %}
            <div class="category-item">
                <input type="checkbox" id="category-{{ category.id }}" name="categories" value="{{ category.id }}">
                <label for="category-{{ category.id }}">{{ category.name }}</label>
            </div>
            {% endfor %}
        </div>
        <div class="question-count">
            <label for="question-count">문제 수:</label>
            <input type="number" id="question-count" min="1" max="20" value="5">
        </div>
        <button id="generate-questions" class="btn btn-primary">문제 생성</button>
    </div>

    <div id="questions-container" class="questions-container">
        <!-- 문제들이 여기에 동적으로 추가됩니다 -->
    </div>
</div>

<template id="question-template">
    <div class="question-card">
        <h3 class="question-title"></h3>
        <div class="statements">
            <!-- 지문들이 여기에 동적으로 추가됩니다 -->
        </div>
        <div class="question-controls">
            <button class="btn btn-primary submit-answer">답안 제출</button>
            <button class="btn btn-secondary show-explanation" style="display: none;">해설 보기</button>
        </div>
        <div class="explanation" style="display: none;">
            <!-- 해설이 여기에 표시됩니다 -->
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateButton = document.getElementById('generate-questions');
    const questionsContainer = document.getElementById('questions-container');
    const questionTemplate = document.getElementById('question-template');

    generateButton.addEventListener('click', async function() {
        const selectedCategories = Array.from(document.querySelectorAll('input[name="categories"]:checked'))
            .map(cb => cb.value);
        const questionCount = document.getElementById('question-count').value;

        if (selectedCategories.length === 0) {
            alert('최소 하나의 카테고리를 선택해주세요.');
            return;
        }

        try {
            const response = await fetch('/get_random_questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    categories: selectedCategories,
                    count: questionCount
                })
            });

            const questions = await response.json();
            displayQuestions(questions);
        } catch (error) {
            console.error('Error:', error);
            alert('문제를 가져오는 중 오류가 발생했습니다.');
        }
    });

    function displayQuestions(questions) {
        questionsContainer.innerHTML = '';
        
        questions.forEach((question, index) => {
            const questionElement = questionTemplate.content.cloneNode(true);
            const questionCard = questionElement.querySelector('.question-card');
            const titleElement = questionElement.querySelector('.question-title');
            const statementsContainer = questionElement.querySelector('.statements');
            const submitButton = questionElement.querySelector('.submit-answer');
            const showExplanationButton = questionElement.querySelector('.show-explanation');
            const explanationDiv = questionElement.querySelector('.explanation');

            // 문제 제목 설정
            titleElement.textContent = question.title;

            // 지문 추가
            Object.entries(question.statements).forEach(([key, value]) => {
                const statementDiv = document.createElement('div');
                statementDiv.className = 'statement';
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = `question-${index}`;
                radio.value = key;
                radio.id = `question-${index}-${key}`;
                
                const label = document.createElement('label');
                label.htmlFor = `question-${index}-${key}`;
                label.textContent = value;
                
                statementDiv.appendChild(radio);
                statementDiv.appendChild(label);
                statementsContainer.appendChild(statementDiv);
            });

            // 답안 제출 버튼 이벤트
            submitButton.addEventListener('click', function() {
                const selectedAnswer = document.querySelector(`input[name="question-${index}"]:checked`);
                if (!selectedAnswer) {
                    alert('답안을 선택해주세요.');
                    return;
                }

                const isCorrect = parseInt(selectedAnswer.value) === question.correct_answer;
                const statements = statementsContainer.querySelectorAll('.statement');
                
                statements.forEach(statement => {
                    const radio = statement.querySelector('input');
                    const label = statement.querySelector('label');
                    
                    if (parseInt(radio.value) === question.correct_answer) {
                        label.classList.add('correct');
                    } else if (parseInt(radio.value) === parseInt(selectedAnswer.value)) {
                        label.classList.add('incorrect');
                    }
                    
                    radio.disabled = true;
                });

                submitButton.style.display = 'none';
                showExplanationButton.style.display = 'inline-block';
            });

            // 해설 보기 버튼 이벤트
            showExplanationButton.addEventListener('click', function() {
                explanationDiv.textContent = question.explanation;
                explanationDiv.style.display = 'block';
                showExplanationButton.style.display = 'none';
            });

            questionsContainer.appendChild(questionElement);
        });
    }
});
</script>
{% endblock %} 